<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gateman Liveness Check</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            color: #2c3e50;
        }

        .container {
            width: 100%;
            max-width: 460px;
            background: #ffffff;
            border-radius: 24px;
            border: 1px solid #e8f0fe;
            padding: 3rem 2.5rem;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 97, 254, 0.08), 0 8px 24px rgba(0, 0, 0, 0.04);
            position: relative;
        }

        .brand-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .brand-name {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            letter-spacing: -0.5px;
            margin: 0 0 0.5rem 0;
        }

        .brand-subtitle {
            color: #5a6c7d;
            font-size: 0.95rem;
            margin: 0 0 1rem 0;
            line-height: 1.4;
        }

        .success-icon {
            font-size: 4rem;
            margin: 2rem 0 1.5rem 0;
            animation: successPulse 2s ease-in-out infinite;
        }

        .success-title {
            font-size: 2rem;
            font-weight: 700;
            color: #27ae60;
            margin-bottom: 1rem;
            letter-spacing: -0.5px;
        }

        .success-message {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .success-footer {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e8f0fe;
        }

        .success-note {
            color: #5a6c7d;
            font-size: 0.9rem;
            margin: 0;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .challenge-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .instruction {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .video-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 280px;
            object-fit: cover;
            border-radius: 15px;
        }

        .countdown {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
        }

                 .status {
             position: absolute;
             bottom: 1rem;
             left: 50%;
             transform: translateX(-50%);
             background: rgba(0, 0, 0, 0.7);
             padding: 0.5rem 1rem;
             border-radius: 20px;
             font-size: 0.9rem;
         }

         .direction-prompt {
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: rgba(79, 70, 229, 0.9);
             color: white;
             padding: 1rem 2rem;
             border-radius: 20px;
             font-size: 2rem;
             font-weight: bold;
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
             border: 3px solid rgba(255, 255, 255, 0.5);
             animation: directionPulse 0.5s ease-in-out;
         }

         @keyframes directionPulse {
             0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
             50% { transform: translate(-50%, -50%) scale(1.1); }
             100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
         }

         .direction-arrows {
             display: inline-block;
             margin-left: 0.5rem;
         }

        .btn {
            background: #f8faff;
            border: 2px solid #e8f0fe;
            color: #5a6c7d;
            padding: 1rem 2rem;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 0.5rem 0;
        }

        .btn:hover {
            background: #e8f0fe;
            border-color: #d1e4ff;
            color: #2c3e50;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: linear-gradient(135deg, #0061FE, #005AE6);
            border-color: #0061FE;
            color: white;
            box-shadow: 0 4px 16px rgba(0, 97, 254, 0.3);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #005AE6, #0052CC);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 97, 254, 0.4);
        }

        .result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 15px;
            font-weight: 600;
        }

        .result.success {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid rgba(76, 175, 80, 0.8);
        }

        .result.failure {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid rgba(244, 67, 54, 0.8);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
                margin: 0.5rem;
            }
            
            #video {
                height: 240px;
            }
            
            .challenge-icon {
                font-size: 3rem;
            }
            
            h1 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Initial Screen -->
        <div id="initial-screen">
            <div class="brand-header">
                <h2 class="brand-name">Gateman</h2>
                <p class="brand-subtitle">Secure Liveness Verification</p>
            </div>
            <div id="challenge-icon" class="challenge-icon">üõ°Ô∏è</div>
            <h1 id="challenge-title">Liveness Check</h1>
            <p id="challenge-instruction" class="instruction">
                Please follow the on-screen directions to verify your identity
            </p>
            <button id="start-btn" class="btn primary">Start Verification</button>
        </div>

                 <!-- Challenge Screen -->
         <div id="challenge-screen" class="hidden">
             <div class="video-container">
                 <video id="video" autoplay muted playsinline></video>
                 <div id="countdown" class="countdown">3</div>
                 <div id="status" class="status">Position your face in view</div>
                 <div id="direction-prompt" class="direction-prompt" style="display: none;">
                     <span id="direction-text">Look Up</span>
                     <span id="direction-arrow" class="direction-arrows">‚¨ÜÔ∏è</span>
                 </div>
             </div>
             <button id="stop-btn" class="btn" disabled>Recording...</button>
         </div>

        <!-- Failure Screen -->
        <div id="result-screen" class="hidden">
            <div class="brand-header">
                <h2 class="brand-name">Gateman</h2>
                <p class="brand-subtitle">Secure Liveness Verification</p>
            </div>
            <div id="result-icon" class="challenge-icon">‚ùå</div>
            <h1 id="result-title">Verification Failed</h1>
            <div id="result-details" class="result failure">
                <p id="result-message">Liveness verification was not successful.</p>
            </div>
        </div>

        <!-- Success Screen -->
        <div id="success-screen" class="hidden">
            <div class="brand-header">
                <h2 class="brand-name">Gateman</h2>
                <p class="brand-subtitle">Secure Liveness Verification</p>
            </div>
            <div class="challenge-icon success-icon">‚úÖ</div>
            <h1 class="success-title">Verification Complete</h1>
            <p class="success-message">You have successfully passed the liveness check.</p>
            <div class="success-footer">
                <p class="success-note">Your identity has been verified</p>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden">
            <div class="challenge-icon">
                <div class="loading"></div>
            </div>
            <h1>Processing...</h1>
            <p class="instruction">Analyzing your video, please wait</p>
        </div>
    </div>

    <script>
                 class SimpleLivenessChallenge {
             constructor() {
                 this.challengeType = this.getChallengeType();
                 this.sessionId = this.getSessionId();
                 this.movementSequence = this.getMovementSequence();
                 this.directionDuration = this.getDirectionDuration();
                 this.mediaRecorder = null;
                 this.recordedChunks = [];
                 this.stream = null;
                 this.isRecording = false;
                 this.duration = this.calculateDuration();
                 this.currentDirectionIndex = 0;
                 this.directionInterval = null;
                 
                 this.initializeChallenge();
                 this.bindEvents();
             }

                       getChallengeType() {
               const urlParams = new URLSearchParams(window.location.search);
               return urlParams.get('type') || 'head_movement';
           }

                         getSessionId() {
                 const urlParams = new URLSearchParams(window.location.search);
                 return urlParams.get('session') || 'demo';
             }

             getMovementSequence() {
                 const urlParams = new URLSearchParams(window.location.search);
                 const sequenceParam = urlParams.get('sequence');
                 if (sequenceParam) {
                     try {
                         return JSON.parse(decodeURIComponent(sequenceParam));
                     } catch (e) {
                         console.error('Failed to parse movement sequence:', e);
                     }
                 }
                 return null;
             }

             getDirectionDuration() {
                 const urlParams = new URLSearchParams(window.location.search);
                 return parseFloat(urlParams.get('direction_duration') || '6.0');
             }

             calculateDuration() {
                 if (this.challengeType === 'smile') {
                     return 3;
                 } else if (this.challengeType === 'head_movement' && this.movementSequence) {
                     return this.movementSequence.length * this.directionDuration;
                 }
                 return 6; // fallback
             }

                                     initializeChallenge() {
                // Gateman only supports head movement challenges
                document.getElementById('challenge-icon').textContent = 'üõ°Ô∏è';
                document.getElementById('challenge-title').textContent = 'Gateman Liveness Check';
                
                if (this.movementSequence && this.movementSequence.length > 0) {
                    const sequenceText = this.movementSequence.map(dir => this.getDirectionEmoji(dir)).join(' ‚Üí ');
                    document.getElementById('challenge-instruction').textContent = 
                        `Follow the sequence: ${sequenceText}. Look in each direction for 3 seconds, then back at camera for 3 seconds.`;
                } else {
                    document.getElementById('challenge-instruction').textContent = 'Move your head as directed for liveness verification';
                }
            }

             getDirectionEmoji(direction) {
                 const emojis = {
                     'up': '‚¨ÜÔ∏è',
                     'down': '‚¨áÔ∏è', 
                     'left': '‚¨ÖÔ∏è',
                     'right': '‚û°Ô∏è'
                 };
                 return emojis[direction] || '‚ùì';
             }

            bindEvents() {
                document.getElementById('start-btn').addEventListener('click', () => this.startChallenge());
                document.getElementById('stop-btn').addEventListener('click', () => this.stopChallenge());
            }

            async startChallenge() {
                try {
                    // Request camera access
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            frameRate: { ideal: 30 },
                            facingMode: 'user'
                        },
                        audio: false
                    });

                    // Setup video
                    const video = document.getElementById('video');
                    video.srcObject = this.stream;

                    // Show challenge screen
                    this.showScreen('challenge-screen');

                    // Start countdown and recording
                    this.startCountdown();

                } catch (error) {
                    console.error('Camera access failed:', error);
                    alert('Camera access is required for the liveness challenge. Please allow camera access and try again.');
                }
            }

            startCountdown() {
                let countdown = 3;
                const countdownEl = document.getElementById('countdown');
                const statusEl = document.getElementById('status');
                
                statusEl.textContent = 'Get ready...';
                
                const countdownInterval = setInterval(() => {
                    countdownEl.textContent = countdown;
                    
                    if (countdown === 0) {
                        clearInterval(countdownInterval);
                        this.startRecording();
                    }
                    countdown--;
                }, 1000);
            }

            startRecording() {
                try {
                    this.recordedChunks = [];
                    
                    // Setup MediaRecorder
                    const options = { mimeType: 'video/webm' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = 'video/mp4';
                    }
                    
                    this.mediaRecorder = new MediaRecorder(this.stream, options);
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        this.processRecording();
                    };

                    // Start recording
                    this.mediaRecorder.start(100);
                    this.isRecording = true;

                                         // Update UI
                     const statusEl = document.getElementById('status');
                     const countdownEl = document.getElementById('countdown');
                     
                     if (this.challengeType === 'smile') {
                         statusEl.textContent = 'Smile now! üòä';
                     } else if (this.challengeType === 'head_movement' && this.movementSequence) {
                         statusEl.textContent = 'Follow the prompts!';
                         this.startDirectionalPrompts();
                     } else {
                         statusEl.textContent = 'Move your head left ‚ÜîÔ∏è right';
                     }

                     // Auto-stop after duration
                     let timeLeft = this.duration;
                     const recordingInterval = setInterval(() => {
                         countdownEl.textContent = Math.ceil(timeLeft);
                         timeLeft -= 0.1;
                         
                         if (timeLeft <= 0) {
                             clearInterval(recordingInterval);
                             this.stopRecording();
                         }
                     }, 100);

                } catch (error) {
                    console.error('Recording failed:', error);
                    alert('Recording failed. Please try again.');
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                }
            }

                         stopChallenge() {
                 this.stopRecording();
             }

                         startDirectionalPrompts() {
                if (!this.movementSequence || this.movementSequence.length === 0) {
                    return;
                }

                const directionPrompt = document.getElementById('direction-prompt');
                const directionText = document.getElementById('direction-text');
                const directionArrow = document.getElementById('direction-arrow');
                
                this.currentDirectionIndex = 0;
                this.isShowingDirection = true; // Track if showing direction or "look center"
                
                // Direction: 2 seconds, Look at camera: 1.5 seconds
                const directionDuration = 2000; // 2 seconds for head movement
                const cameraDuration = 1500; // 1.5 seconds for looking at camera
                
                const showNextStep = () => {
                    if (this.currentDirectionIndex >= this.movementSequence.length) {
                        directionPrompt.style.display = 'none';
                        return;
                    }
                    
                    if (this.isShowingDirection) {
                        // Show the direction
                        const direction = this.movementSequence[this.currentDirectionIndex];
                        const directionNames = {
                            'up': 'Look Up',
                            'down': 'Look Down',
                            'left': 'Look Left', 
                            'right': 'Look Right'
                        };
                        
                        directionText.textContent = directionNames[direction] || direction;
                        directionArrow.textContent = this.getDirectionEmoji(direction);
                        
                        // Next step will be "look center"
                        this.isShowingDirection = false;
                    } else {
                        // Show "look back at camera" instruction
                        directionText.textContent = 'Look at Camera';
                        directionArrow.textContent = 'üì∑';
                        
                        // Next step will be next direction
                        this.isShowingDirection = true;
                        this.currentDirectionIndex++;
                    }
                    
                    // Show the prompt with animation
                    directionPrompt.style.display = 'block';
                    directionPrompt.style.animation = 'none';
                    setTimeout(() => {
                        directionPrompt.style.animation = 'directionPulse 0.5s ease-in-out';
                    }, 10);
                };
                
                // Show first direction immediately
                showNextStep();
                
                // Schedule next steps with appropriate timing
                const scheduleNextStep = () => {
                    if (this.currentDirectionIndex >= this.movementSequence.length) {
                        return;
                    }
                    
                    // Use different durations based on current step type
                    const currentDuration = this.isShowingDirection ? directionDuration : cameraDuration;
                    
                    this.directionTimeout = setTimeout(() => {
                        showNextStep();
                        scheduleNextStep(); // Schedule the next step
                    }, currentDuration);
                };
                
                // Start the scheduling
                scheduleNextStep();
            }

            async processRecording() {
                this.showScreen('loading-screen');

                try {
                    // Create video blob
                    const videoBlob = new Blob(this.recordedChunks, { 
                        type: this.mediaRecorder.mimeType || 'video/webm' 
                    });

                                         // Submit to backend
                     const formData = new FormData();
                     formData.append('session_id', this.sessionId);
                     formData.append('challenge_type', this.challengeType);
                     formData.append('video', videoBlob, 'challenge.webm');
                     
                     // Add movement sequence for head movement challenges
                     if (this.challengeType === 'head_movement' && this.movementSequence) {
                         formData.append('movement_sequence', JSON.stringify(this.movementSequence));
                     }

                    const response = await fetch('/submit-simple-challenge', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    this.showResult(result);

                } catch (error) {
                    console.error('Processing failed:', error);
                    this.showResult({
                        success: false,
                        error: 'Failed to process video'
                    });
                }
            }

                         showResult(result) {
                 this.cleanup();
                 
                 const resultIcon = document.getElementById('result-icon');
                 const resultTitle = document.getElementById('result-title');
                 const resultDetails = document.getElementById('result-details');
                 const resultMessage = document.getElementById('result-message');

                                 if (result.success && result.result === 'pass') {
                    // Show dedicated success screen
                    this.showScreen('success-screen');
                    return;
                 } else {
                     resultIcon.textContent = '‚ùå';
                     resultTitle.textContent = 'Challenge Failed';
                     resultDetails.className = 'result failure';
                     
                     let errorMessage = result.error || `The ${this.challengeType.replace('_', ' ')} was not detected clearly. Please try again.`;
                     
                     // Add sequence details for failed head movement
                     if (this.challengeType === 'head_movement' && result.details && result.details.expected_sequence) {
                         const expectedEmojis = result.details.expected_sequence.map(dir => this.getDirectionEmoji(dir)).join(' ‚Üí ');
                         const detectedEmojis = result.details.detected_sequence ? 
                             result.details.detected_sequence.map(dir => this.getDirectionEmoji(dir)).join(' ‚Üí ') : 
                             'Unable to detect';
                         
                         // Check if sequences match but failed due to anti-spoofing
                         if (detectedEmojis === expectedEmojis) {
                             errorMessage = 'Head movement was correct, but anti-spoofing validation failed. Please ensure good lighting and natural movement.';
                         } else {
                             errorMessage += `\n\nExpected sequence: ${expectedEmojis}\nDetected sequence: ${detectedEmojis}`;
                         }
                     }
                     
                     resultMessage.textContent = errorMessage;
                 }

                 this.showScreen('result-screen');
             }



            showScreen(screenId) {
                const screens = ['initial-screen', 'challenge-screen', 'result-screen', 'success-screen', 'loading-screen'];
                screens.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }

                         cleanup() {
                 if (this.stream) {
                     this.stream.getTracks().forEach(track => track.stop());
                     this.stream = null;
                 }
                 
                 if (this.mediaRecorder) {
                     this.mediaRecorder = null;
                 }
                 
                                 if (this.directionTimeout) {
                    clearTimeout(this.directionTimeout);
                    this.directionTimeout = null;
                }
                 
                 // Hide direction prompt
                 const directionPrompt = document.getElementById('direction-prompt');
                 if (directionPrompt) {
                     directionPrompt.style.display = 'none';
                 }
                 
                 this.recordedChunks = [];
                 this.isRecording = false;
                 this.currentDirectionIndex = 0;
             }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleLivenessChallenge();
        });
    </script>
</body>
</html> 